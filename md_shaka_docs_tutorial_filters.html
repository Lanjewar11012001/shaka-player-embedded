<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Shaka Player Embedded: Network Filters</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Shaka Player Embedded
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Network Filters </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Shaka Player Embedded supports network request and response filters similarly to the JavaScript Shaka Player project. Also see <a href="https://shaka-player-demo.appspot.com/docs/api/tutorial-license-wrapping.html">their tutorial</a>.</p>
<p>Filters are added to either the <code><a class="el" href="classshaka_1_1Player.html">shaka::Player</a></code> (C++) or <code><a class="el" href="interfaceShakaPlayer.html">ShakaPlayer</a></code> (Objective-C/Swift) types. Filters are per-Player and can be different with different Player instances. You can also add multiple filters if desired; filters are called in the order they are registered and are called sequentially. Filters are implemented as objects that implement a required interface. There is a callback for request and response calls. You don't have to implement both; if either are missing, a no-op filter will be used.</p>
<h2>Basic Filters</h2>
<div class="fragment"><div class="line"><span class="keyword">class </span>MyFilter : <span class="keyword">public</span> <a class="code" href="classshaka_1_1NetworkFilters.html">shaka::NetworkFilters</a> {</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">  std::future&lt;shaka::optional&lt;shaka::Error&gt;&gt; <a class="code" href="classshaka_1_1NetworkFilters.html#a174c8a2d294be5b6af5d6decbc777e0a">OnRequestFilter</a>(</div><div class="line">      <a class="code" href="namespaceshaka.html#ad8d6919b5dcc8557f2fc6f169f48496c">shaka::RequestType</a> <a class="code" href="dom__exception_8cc.html#a413eab66b8192a2ac20583b419ab9d8a">type</a>, <a class="code" href="classshaka_1_1Request.html">shaka::Request</a>* request)<span class="keyword"> override </span>{</div><div class="line">    <span class="keywordflow">if</span> (type == <a class="code" href="namespaceshaka.html#ad8d6919b5dcc8557f2fc6f169f48496ca794df3791a8c800841516007427a2aa3">shaka::RequestType::License</a>) {</div><div class="line">      request-&gt;<a class="code" href="classshaka_1_1Request.html#a0351e3c1054f39fc0f08fee356824040">headers</a>[<span class="stringliteral">&quot;foo&quot;</span>] = <span class="stringliteral">&quot;bar&quot;</span>;</div><div class="line"></div><div class="line">      std::vector&lt;uint8_t&gt; body =</div><div class="line">          {request-&gt;<a class="code" href="classshaka_1_1Request.html#a6cad265f414cdcde3b66de921824929e">body</a>(), request-&gt;<a class="code" href="classshaka_1_1Request.html#a6cad265f414cdcde3b66de921824929e">body</a>() + request-&gt;<a class="code" href="classshaka_1_1Request.html#a746cc27840cec2058272467a78b323f1">body_size</a>()};</div><div class="line">      WrapRequest(body);  <span class="comment">// Process request body if needed.</span></div><div class="line">      request-&gt;<a class="code" href="classshaka_1_1Request.html#a8903c3922c7d5c90339b16a3a3017b0c">SetBodyCopy</a>(body.data(), body.size());</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> {};  <span class="comment">// Can just use std::future default constructor.</span></div><div class="line">  }</div><div class="line">};</div></div><!-- fragment --><div class="fragment"><div class="line">\<span class="keyword">@interface </span>MyFilter : NSObject &lt;ShakaPlayerNetworkFilter&gt;</div><div class="line"></div><div class="line">- (void)onPlayer:(<a class="code" href="interfaceShakaPlayer.html">ShakaPlayer</a> *)player</div><div class="line">  networkRequest:(<a class="code" href="interfaceShakaPlayerRequest.html">ShakaPlayerRequest</a> *)request</div><div class="line">          ofType:(ShakaPlayerRequestType)type</div><div class="line">       withBlock:(<a class="code" href="ShakaPlayer_8h.html#a67662d37a404ad2b30adee6572112e63">ShakaPlayerAsyncBlock</a>)block;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">@implementation </span>MyFilter</div><div class="line"></div><div class="line">- (void)onPlayer:(<a class="code" href="interfaceShakaPlayer.html">ShakaPlayer</a> *)player</div><div class="line">  networkRequest:(<a class="code" href="interfaceShakaPlayerRequest.html">ShakaPlayerRequest</a> *)request</div><div class="line">          ofType:(ShakaPlayerRequestType)type</div><div class="line">       withBlock:(<a class="code" href="ShakaPlayer_8h.html#a67662d37a404ad2b30adee6572112e63">ShakaPlayerAsyncBlock</a>)block {</div><div class="line">  <span class="keywordflow">if</span> (type == ShakaPlayerRequestTypeLicense) {</div><div class="line">    request.<a class="code" href="interfaceShakaPlayerRequest.html#a88295ee9ae76f6ed9e16132cad57a57f">headers</a>[@&quot;foo&quot;] = <span class="stringliteral">@&quot;bar&quot;</span>;</div><div class="line">    request.<a class="code" href="interfaceShakaPlayerRequest.html#a4925a9f423f5ee4daea61d13a867e902">body</a> = WrapRequest(request.<a class="code" href="interfaceShakaPlayerRequest.html#a4925a9f423f5ee4daea61d13a867e902">body</a>);</div><div class="line">  }</div><div class="line">  block(nil);  <span class="comment">// MUST call block() at some point to continue request.</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></div><!-- fragment --><div class="fragment"><div class="line">class MyFilter : NSObject, ShakaPlayerNetworkFilter {</div><div class="line">  func onPlayer(_ player: ShakaPlayer, networkRequest: ShakaPlayerRequest,</div><div class="line">                of type: ShakaPlayerRequestType,</div><div class="line">                with block: @escaping ShakaPlayerAsyncBlock) {</div><div class="line">    if (type == .license) {</div><div class="line">      networkRequest.headers[&quot;foo&quot;] = &quot;bar&quot;;</div><div class="line">      networkRequest.body = WrapRequest(networkRequest.body);</div><div class="line">    }</div><div class="line">    block(nil);  // MUST call block() at some point to continue request.</div><div class="line">  }</div><div class="line">};</div></div><!-- fragment --><h2>Asynchronous filters</h2>
<p>Network filters can also be completed asynchronously. This is preferable when lots of work is needed since the filter callbacks block either the JS main thread (in C++) or the app main thread (Objective-C/Swift).</p>
<p>In C++, returning a <code>std::future</code> value is used to indicate async work. An invalid future (e.g. with the default constructor) means the filter completed synchronously. Returning a valid future means the filter is still processing. Once the future resolves, the filter is done. Apps create a <code>std::future</code> instance by using <code>std::async</code> or <code>std::promise</code>.</p>
<div class="fragment"><div class="line">std::future&lt;shaka::optional&lt;shaka::Error&gt;&gt; OnRequestFilter(</div><div class="line">    <a class="code" href="namespaceshaka.html#ad8d6919b5dcc8557f2fc6f169f48496c">shaka::RequestType</a> type, <a class="code" href="classshaka_1_1Request.html">shaka::Request</a>* request) {</div><div class="line">  <span class="comment">// Create a shared_ptr since std::promise isn&#39;t copyable.</span></div><div class="line">  <span class="keyword">auto</span> promise =</div><div class="line">      std::make_shared&lt;std::promise&lt;shaka::optional&lt;shaka::Error&gt;&gt;&gt;();</div><div class="line"></div><div class="line">  <span class="comment">// Do something on a background thread/worker:</span></div><div class="line">  std::thread t([=]() {</div><div class="line">    sleep(10);</div><div class="line"></div><div class="line">    <span class="comment">// Request pointer remains valid until std::future resolves.</span></div><div class="line">    request-&gt;<a class="code" href="classshaka_1_1Request.html#a0351e3c1054f39fc0f08fee356824040">headers</a>[<span class="stringliteral">&quot;foo&quot;</span>] = <span class="stringliteral">&quot;bar&quot;</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Use shaka::optional default constructor to indicate success.</span></div><div class="line">    promise-&gt;set_value({});</div><div class="line">  });</div><div class="line">  t.detach();</div><div class="line"></div><div class="line">  <span class="comment">// Return the future so the main thread can continue.</span></div><div class="line">  <span class="keywordflow">return</span> promise-&gt;get_future();</div><div class="line">}</div></div><!-- fragment --><p>For Objective-C/Swift, you MUST call the <code>block</code> argument when the filter is done. This can be done synchronously within the method, or you can call it later if the filter isn't done yet. Forgetting to call the method will cause the request to hang forever.</p>
<div class="fragment"><div class="line">- (void)onPlayer:(<a class="code" href="interfaceShakaPlayer.html">ShakaPlayer</a> *)player</div><div class="line">  networkRequest:(<a class="code" href="interfaceShakaPlayerRequest.html">ShakaPlayerRequest</a> *)request</div><div class="line">          ofType:(ShakaPlayerRequestType)type</div><div class="line">       withBlock:(<a class="code" href="ShakaPlayer_8h.html#a67662d37a404ad2b30adee6572112e63">ShakaPlayerAsyncBlock</a>)block {</div><div class="line">  <span class="comment">// Do something on a background queue.</span></div><div class="line">  <span class="keywordtype">long</span> priority = DISPATCH_QUEUE_PRIORITY_DEFAULT;</div><div class="line">  dispatch_async(dispatch_get_global_queue(priority, 0), ^{</div><div class="line">    request.<a class="code" href="classshaka_1_1Request.html#a0351e3c1054f39fc0f08fee356824040">headers</a>[<span class="stringliteral">@&quot;foo&quot;</span>] = <span class="stringliteral">@&quot;bar&quot;</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Signal we&#39;re done; can be done on any queue/thread.</span></div><div class="line">    block(nil);</div><div class="line">  });</div><div class="line">}</div></div><!-- fragment --><h2>Reporting Errors</h2>
<p>It is possible for you to report an error from the filter. Doing this will fail the network request. This may result in retries, or it may result in a fatal error. Apps should not use "normal" exceptions to report errors; instead they should create an instance of either <code><a class="el" href="classshaka_1_1Error.html">shaka::Error</a></code> (C++) or <code><a class="el" href="interfaceShakaPlayerError.html">ShakaPlayerError</a></code> (Objective-C/Swift).</p>
<div class="fragment"><div class="line">std::future&lt;shaka::optional&lt;shaka::Error&gt;&gt; OnRequestFilter(</div><div class="line">    <a class="code" href="namespaceshaka.html#ad8d6919b5dcc8557f2fc6f169f48496c">shaka::RequestType</a> type, <a class="code" href="classshaka_1_1Request.html">shaka::Request</a>* request) {</div><div class="line">  std::promise&lt;shaka::optional&lt;shaka::Error&gt;&gt; promise;</div><div class="line"></div><div class="line">  <span class="comment">// Set the error, can be done on background threads/workers.</span></div><div class="line">  promise.set_value(<a class="code" href="classshaka_1_1Error.html">shaka::Error</a>(<span class="stringliteral">&quot;Some error happened&quot;</span>));</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> promise.get_future();</div><div class="line">}</div></div><!-- fragment --><div class="fragment"><div class="line">- (void)onPlayer:(<a class="code" href="interfaceShakaPlayer.html">ShakaPlayer</a> *)player</div><div class="line">  networkRequest:(<a class="code" href="interfaceShakaPlayerRequest.html">ShakaPlayerRequest</a> *)request</div><div class="line">          ofType:(ShakaPlayerRequestType)type</div><div class="line">       withBlock:(<a class="code" href="ShakaPlayer_8h.html#a67662d37a404ad2b30adee6572112e63">ShakaPlayerAsyncBlock</a>)block {</div><div class="line">  <a class="code" href="interfaceShakaPlayerError.html">ShakaPlayerError</a> *error =</div><div class="line">      [[<a class="code" href="interfaceShakaPlayerError.html">ShakaPlayerError</a> alloc] initWithMessage:<span class="stringliteral">@&quot;Something happened&quot;</span>];</div><div class="line">  block(error);</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
